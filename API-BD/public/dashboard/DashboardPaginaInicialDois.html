<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeSensor | Página Inicial</title>
    <link rel="stylesheet" href="../css/PáginaInicialDois.css">
    <link rel="shortcut icon" href="../assets/imagens/favicon.png" type="image/x-icon">
    <link rel="shortcut icon" href="SRC/imagens/favicon.png" type="image/x-icon">
    <script src="../js/sessao.js"></script>
</head>

<body onload="listarCaminhoes(), kpiQtdTemperaturaInstavel(), kpiQtdUmidadeInstavel(), kpiPorcentagemInstavel(),validarSuperior()">

    <div id="menuLateral">

        <h1>Code<br><span id="sensor">Sensor</span></h1>

        <h2 id="nomeSession"></h2>

        <div id="containerBotoes">
            <a id="botaoInicial" href="DashboardPaginaInicial.html">PÁGINA INICIAL</a>
            <a class="botao" href="tela_caminhoesRegistrados.html">CAMINHÕES</a>
            <a id="btn_superior" style="display: none;" class="botao" href="opcoesCadastro.html">CADASTRO</a>

            <a id="botaoSair" href="../index.html">SAIR</a>
        </div>

    </div>

    <div id="containerTudo">

        <div class="containerTitulo">

            <h1 class="titulo">
                GRÁFICOS GERAIS
            </h1>

        </div>

        <div id="containerKpi">
            <div class="kpi kpiInstavel">
                <img src="../assets/imagens/temperaturaComAlerta.png">
                <span>
                    <h2>CAMINHÕES INSTÁVEIS</h2>
                    <h1 id="qtdTemperatura"></h1>
                    <h4>Por Temperatura</h4>
                </span>
            </div>

            <div class="kpi kpiInstavel">
                <img src="../assets/imagens/umidadeComAlerta.png" class="iconeKpi">
                <span>
                    <h2>CAMINHÕES INSTÁVEIS</h2>
                    <h1 id="qtdUmidade"></h1>
                    <h4>Por Umidade</h4>
                </span>
            </div>

            <div class="kpi">
                <img src="../assets/imagens/image 39.png" class="iconeKpi">
                <span>

                    <h2>PORCENTAGEM DE INSTÁVEIS</h2>
                    <h1 id="porcentagem"></h1>
                </span>
            </div>

        </div>

        <div class="containerTitulo">
            <h2 class="subTitulo">CAMINHÕES INSTÁVEIS</h2>
        </div>

        <div id="divListas">

            <div class="listaCaminhaoInstavel" id="listaCaminhoes">

                <table class="containerLista" id="tabelaCaminhoes">

                    <tr class="headerLista">
                        <th>Caminhão e Sensor</th>
                        <th>Tipo de Carne</th>
                        <th>Última Temperatura</th>
                        <th>Última Umidade</th>
                    </tr>

                    <!-- <tr id="linha" class="linhaImpar">
                        <td>
                            <div class="placa">
                            <a href="DashboardCaminhaoIndividual.html">
                                NCZ2329
                            </a>
                            <span class="sensor">Sensor 1</span>
                        </div>
                        </td>
                        <td>Bovina</td>
                        <td>2ºC</td>
                        <td>85%</td>
                    </tr> -->

                    <!-- <tr class="linhaPar">
                        <td>
                            <div class="placa">
                                <a href="DashboardCaminhaoIndividual.html">
                                    MYL4122
                                </a>
                                <span class="sensor">Sensor 2</span>
                            </div>
                        </td>
                        <td>Ave</td>
                        <td>4ºC</td>
                        <td>86%</td>
                    </tr> -->

                </table>

            </div>

        </div>

    </div>

</body>

</html>

<script>

    let idFilial = sessionStorage.getItem('ID_FILIAL');
    let fkEmpresa = sessionStorage.getItem('ID_EMPRESA');
    
    let tipoEmpresa = sessionStorage.getItem('TIPO_EMPRESA');
    
    if (tipoEmpresa == 'filial') {

        idFilial = fkEmpresa;

    }

    // Apenas dados da Filial. Se matriz quiser olhar? ID_EMPRESA = ID_FILIAL

    setInterval(kpiQtdTemperaturaInstavel, 2000);
    setInterval(kpiQtdUmidadeInstavel, 2000);
    setInterval(kpiPorcentagemInstavel, 2000);

    function kpiQtdTemperaturaInstavel() {

        fetch(`/empresas/qtdTemperaturaInstavelFilial/${idFilial}/${fkEmpresa}`).then(function (response) {
            if (response.ok) {

                response.json().then(function (resposta) {

                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    sessionStorage.QTD_TEMPERATURA_INSTAVEL = resposta[0].qtdInstaveisTemperatura;

                    qtdTemperatura.innerHTML = sessionStorage.getItem('QTD_TEMPERATURA_INSTAVEL');

                })
            } else {

                console.log('Nenhum valor econtrado ou erro na API!');

            }

        })
            .catch(function (error) {

                console.log(`Erro na captura dos para a KPI ${error.message}`);

            });

        return false;

    }

    function kpiQtdUmidadeInstavel() {

        fetch(`/empresas/qtdUmidadeInstavelFilial/${idFilial}/${fkEmpresa}`).then(function (response) {
            if (response.ok) {

                response.json().then(function (resposta) {

                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    sessionStorage.QTD_UMIDADE_INSTAVEL = resposta[0].qtdInstaveisUmidade;

                    qtdUmidade.innerHTML = sessionStorage.getItem('QTD_UMIDADE_INSTAVEL');

                })
            } else {

                console.log('Nenhum valor econtrado ou erro na API!');

            }

        })
            .catch(function (error) {

                console.log(`Erro na captura dos para a KPI ${error.message}`);

            });

        return false;

    }

    function kpiPorcentagemInstavel() {

        fetch(`/empresas/porcentagemInstavelFilial/${idFilial}/${fkEmpresa}`).then(function (response) {
            if (response.ok) {

                response.json().then(function (resposta) {

                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    sessionStorage.PORCENTAGEM_INSTAVEL = resposta[0].porcentagemInstavelFilial;

                    porcentagem.innerHTML = `${sessionStorage.getItem('PORCENTAGEM_INSTAVEL')}%`

                })
            } else {

                console.log('Nenhum valor econtrado ou erro na API!');

            }

        })
            .catch(function (error) {

                console.log(`Erro na captura dos para a KPI ${error.message}`);

            });

        return false;

    }

    function listarCaminhoes() {

        fetch(`/empresas/listarCaminhoes/${idFilial}/${fkEmpresa}`).then(function (resposta) {

            if (resposta.ok) {
                if (resposta.status == 204) {
                    listaCaminhoes.innerHTML = "<h1>Nenhum caminhão foi encontrado.</h1>"
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {
                        var dados = resposta[i];

                        let idPlaca = dados.placa;

                        let tipoCarne = dados.tipoCarne;
                        tipoCarne = tipoCarne.replace(tipoCarne[0], tipoCarne[0].toUpperCase())

                        tabelaCaminhoes.innerHTML += ` <tr id="linha${i}">
                        <td>
                            <div class="placa">
                            <a href='DashboardCaminhaoIndividual.html' id='${idPlaca}' onclick='guardarPlaca(this.id)'>
                            ${dados.placa}
                            </a>
                            <span class="sensor">Sensor ${dados.idSensor}</span>
                        </div>
                        </td>
                        <td>${tipoCarne}</td>
                        <td><span id="temperatura${i}">${dados.temperatura}ºC</span></td>
                        <td><span id="umidade${i}">${dados.umidade}%</span></td>
                    </tr>`;

                        if (i % 2 == 0) {

                            document.getElementById(`linha${i}`).classList.add("linhaImpar");

                        } else {

                            document.getElementById(`linha${i}`).classList.add("linhaPar");

                        }

                        if (dados.temperatura > 4 || dados.temperatura < 0) {

                            document.getElementById(`temperatura${i}`).classList.add("critico");

                        }

                        if (dados.umidade < 85 || dados.umidade > 95) {

                            document.getElementById(`umidade${i}`).classList.add("critico");

                        }

                        if (i == resposta.length-1) {

                            document.getElementById(`linha${i}`).style.borderBottomLeftRadius = "18px";

                        }

                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });

    }

    var tipo = sessionStorage.TIPO_USUARIO;
    function validarSuperior(){
        if(tipo == "superior"){
            btn_superior.style.display = "flex";
        }else{
            btn_superior.style.display = "none";

        }

    }

    function guardarPlaca(idPlaca) {
    
       sessionStorage.PLACA_CAMINHAO = idPlaca;

    }

</script>